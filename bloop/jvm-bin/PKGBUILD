_version=1.4.0-RC1

pkgname=bloop-jvm-bin
pkgver="${_version//-/_}"
pkgrel=1
pkgdesc="Bloop gives you fast edit/compile/test workflows for Scala. (jvm launcher version)"
arch=(any)
url="https://scalacenter.github.io/bloop/"
provides=('bloop')
conflicts=('bloop')
license=('Apache')
depends=('java-environment>=8' 'python')
makedepends=('coursier')


_nailgunver=a2520c1e

source=(
    "bloop-${pkgver}.tar.gz::https://github.com/scalacenter/bloop/archive/v${_version}.tar.gz"
    "nailgun-client::https://raw.githubusercontent.com/scalacenter/nailgun/${_nailgunver}/pynailgun/ng.py"
)
sha256sums=(
    'cafe235734d2bb3ab34257fa48b902cbe126e677439f6e76c0c6be85747fe945'
    '66e22177333477d32204317f12a90e37f80ec24d5b7fbfbddddc16b27df797a9'
)

build() {
  cd "$srcdir"
  
  # basically there are a bunch of resources to install
  # and the bloop server and client.
  # the client is the thing called nailgun, which is python, wtv that is.
  # the server we generate with a magic incantation of the coursier that embeds 
  # a magically bootstrapable binary or something like that. if not is close.
  
  coursier bootstrap ch.epfl.scala:bloop-frontend_2.12:${_version} \
    -r bintray:scalameta/maven \
    -r bintray:scalacenter/releases \
    -r https://oss.sonatype.org/content/repositories/staging \
    -o blp-server -f --main bloop.Server
  
  # fix paths
  cd "$srcdir/bloop-${_version}"
  sed -i "s|__BLOOP_INSTALLATION_TARGET__|/usr/bin|g" etc/systemd/bloop.service

  sed -i "s|__BLOOP_INSTALLATION_TARGET__/xdg|/usr/share/pixmaps|g" etc/xdg/bloop.desktop
  sed -i "s|__BLOOP_INSTALLATION_TARGET__|/usr/bin|g" etc/xdg/bloop.desktop
}

package() {
  cd "$srcdir"

  ## binaries
  install -Dm755 blp-server "$pkgdir"/usr/bin/blp-server
  install -Dm755 nailgun-client "$pkgdir"/usr/bin/bloop

  cd "$srcdir/bloop-${_version}"
  
  # desktop file
  install -Dm644 etc/xdg/bloop.png "$pkgdir"/usr/share/pixmaps/bloop.png
  install -Dm644 etc/xdg/bloop.desktop "$pkgdir"/usr/share/applications/bloop.desktop

  # shell completion
  install -Dm644 etc/bash/bloop "$pkgdir"/etc/bash_completion.d/bloop
  install -Dm644 etc/zsh/_bloop "$pkgdir"/usr/share/zsh/site-functions/_bloop
  install -Dm644 etc/fish/bloop.fish "$pkgdir"/usr/share/fish/vendor_completions.d/bloop.fish

  # systemd service
  install -Dm644 etc/systemd/bloop.service "$pkgdir"/usr/lib/systemd/user/bloop.service
}
